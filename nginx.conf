# HYLiR çœ‹æ¿ç³»ç»Ÿ Nginx é…ç½®
# ç”¨äºç”Ÿäº§ç¯å¢ƒåå‘ä»£ç†

# è¿è¡Œç”¨æˆ·
user  nginx;
# å·¥ä½œè¿›ç¨‹æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸?CPU æ ¸å¿ƒæ•?worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format  main  ' -  [] "" '
                      '  "" '
                      '"" ""';

    access_log  /var/log/nginx/access.log  main;

    # å¼€å¯é«˜æ•ˆä¼ è¾?    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    
    # è¿æ¥è¶…æ—¶æ—¶é—´
    keepalive_timeout  65;
    
    # Gzip å‹ç¼©
    gzip  on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ä¸Šæ¸¸ API æœåŠ¡å™?    upstream api_backend {
        server 117.143.214.90:3680;
    }

    # HTTP æœåŠ¡å™¨é‡å®šå‘åˆ?HTTPSï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨ HTTPSï¼?    # server {
    #     listen 80;
    #     server_name _;
    #     return 301 https://System.Management.Automation.Internal.Host.InternalHost;
    # }

    # HTTPS æœåŠ¡å™¨é…ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨ HTTPSï¼?    # server {
    #     listen 443 ssl;
    #     server_name ä½ çš„åŸŸåæˆ–IP;
    #     
    #     # SSL è¯ä¹¦é…ç½®
    #     ssl_certificate      /path/to/ssl/certificate.crt;
    #     ssl_certificate_key  /path/to/ssl/private.key;
    #     
    #     ssl_session_timeout  1d;
    #     ssl_session_cache    shared:SSL:50m;
    #     ssl_protocols        TLSv1.2 TLSv1.3;
    #     ssl_ciphers          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    #     
    #     location / {
    #         root   /usr/share/nginx/html;
    #         index  index.html index.htm;
    #         try_files  / /index.html;
    #     }
    #     
    #     location /api/ {
    #         proxy_pass http://api_backend;
    #         proxy_set_header Host System.Management.Automation.Internal.Host.InternalHost;
    #         proxy_set_header X-Real-IP ;
    #         proxy_set_header X-Forwarded-For ;
    #         proxy_set_header X-Forwarded-Proto ;
    #     }
    # }

    # HTTP æœåŠ¡å™¨é…ç½®ï¼ˆä¸ä½¿ç”?HTTPS æ—¶ï¼‰
    server {
        # ç›‘å¬ç«¯å£
        listen 80;
        
        # ä½ çš„åŸŸåæˆ?IP åœ°å€
        server_name ä½ çš„åŸŸåæˆ–IP;

        # å‰ç«¯é™æ€æ–‡ä»¶ç›®å½?        root   /usr/share/nginx/html;
        index  index.html index.htm;

        # å‰ç«¯è·¯ç”±æ”¯æŒï¼ˆSPAï¼?        location / {
            try_files  / /index.html;
        }

        # API åå‘ä»£ç†
        location /api/ {
            proxy_pass http://api_backend;
            
            # ä»£ç†è¯·æ±‚å¤?            proxy_set_header Host System.Management.Automation.Internal.Host.InternalHost;
            proxy_set_header X-Real-IP ;
            proxy_set_header X-Forwarded-For ;
            proxy_set_header X-Forwarded-Proto ;
            
            # è¿æ¥è¶…æ—¶
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # é™æ€èµ„æºç¼“å­?        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
